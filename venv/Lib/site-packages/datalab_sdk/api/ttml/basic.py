from logging import info, debug, error
from typing import Any, Dict, Type, TypeVar, Union, List, Callable, Mapping, Optional, cast

import requests
from marshmallow import ValidationError
from marshmallow_dataclass import class_schema

# want to make easy import for clients of SDK
from datalab_sdk.api.exceptions import *
from datalab_sdk.api.raw import RawClient, JSONResponseType
from datalab_sdk.config.environment import (
    Environment,
    EnvironmentConfig
)

# import the likely types so clients don't need to know where to find them
from datalab_sdk.api.ttml.exceptions import *
# from datalab_sdk.api.ttml.types.basic_metadata import (

# )

from datalab_sdk.api.common.schema import CamelCaseSchema

# want to read query paramaters
from flask import request
from datalab_sdk.logger import logger

INPUT_CLASS = TypeVar("INPUT_CLASS")
OUTPUT_CLASS = TypeVar("OUTPUT_CLASS")


class BasicTtmlClient(RawClient):
    def __init__(self, environment: Environment = Environment.PROD):
        super().__init__(environment)

################################################################################
# ENDPOINTS
################################################################################

    def post_request(
        self,
        token: str, 
        req_data: dict,
        path: str = '',
        arg: str = ''
    ) -> dict:
        """Post request for ttml.

        Arguments:
            token: str -- The auth token to use for the API call.
            path: str -- The path of ttml API url
            arg: str -- The argument for ttml API url
            req_data: dict -- Request info that needs to be provided for post request body 

        Returns:
            dict -- Post response of ttml

        Errors:
            AuthNotValid - If token is invalid.
        """

        return self.__request_post(
            path=path,
            arg=arg,
            token=token,
            data=req_data,
            input_class=dict,
            output_class=dict,
            not_found=None
        )
    
    def get_request(
        self, 
        token: str, 
        path: str = '',
        arg: str = ''
    ) -> dict:
        """Get request for ttml.

        Arguments:
            token: str -- The auth token to use for the API call.
            path: str -- The path of ttml API url
            arg: str -- The argument for ttml API url

        Returns:
            dict -- Post response of ttml

        Errors:
            AuthNotValid - If token is invalid.
        """
        
        return self.__request_get(
            path=path,
            argument=arg,
            token=token,
            output_class=dict,
            not_found=None
        )

################################################################################
# HELPERS
################################################################################

    def __request_post(
        self, 
        path: str, 
        arg: str,
        token: str,
        data: INPUT_CLASS,
        input_class: Type[INPUT_CLASS], 
        output_class: Optional[Type[OUTPUT_CLASS]],
        not_found: Union[Callable[[str], ResourceNotFound], None] = None,
    ) -> OUTPUT_CLASS:
        input_schema = class_schema(input_class, base_schema=CamelCaseSchema)

        # prepare input body - may be invalid
        try:
            body = input_schema().dump(data)
            info(body)
        except Exception as err:
            logger.debug(err)
            debug(err)
            raise InputNotValid("The provided body data did not match expected content for this API call")

        # make call
        url = EnvironmentConfig.get_ttml_api_url(self._environment, path, arg)

        # Special case where we don't expect a response
        if output_class is None:
            try:
                response = self.post(url, token, body, parse_response=False)
            except TtmlNotFound as err:
                if not_found is not None:
                    # Convert ttml specific errors
                    raise not_found(err.correlation_id)
                else:
                    raise err
            return cast(OUTPUT_CLASS, None)

        # Otherwise, handle output schema
        output_schema = class_schema(output_class, base_schema=CamelCaseSchema)
        try:
            # can safely cast to JSONResponseType since parse_json defaults to True
            response = cast(JSONResponseType, self.post(url, token, body))
        except Exception as err:
            raise err

        # prepare outputs
        info(response)
        try:
            return output_schema().load(response)
        except:
            correlation_id = None
            if isinstance(response, Mapping) and "correlationId" in response:
                # capture correlation if present
                correlation_id = response["correlationId"]
            raise APIChanged("Could not parse response into output schema", correlation_id, 400)
    
    def __request_get(
        self, path: str, token: str, argument: str,
        output_class: Type[OUTPUT_CLASS],
        not_found: Union[Callable[[str], ResourceNotFound], None] = None
    ) -> OUTPUT_CLASS:
        output_schema = class_schema(output_class, base_schema=CamelCaseSchema)

        # make call
        url = EnvironmentConfig.get_ttml_api_url(self._environment, path, argument)

        try:
            # can safely cast to JSONResponseType since parse_json defaults to True
            response = cast(JSONResponseType, self.get(url, token))
        except TtmlNotFound as err:
            logger.debug(err)
            if not_found is not None:
                # Convert ttml specific errors
                raise not_found(err.correlation_id)
            else:
                raise err

        # prepare outputs
        info(response)
        try:
            return output_schema().load(response)
        except:
            correlation_id = None
            if isinstance(response, Mapping) and "correlationId" in response:
                # capture correlation if present
                correlation_id = response["correlationId"]
            raise APIChanged("Could not parse response into output schema", correlation_id, 400)